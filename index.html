<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenShift Sizing Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@^3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .result-card {
             background-color: #f3f4f6;
             border: 1px solid #e5e7eb;
        }
        .info-box {
            background-color: #eef2ff;
            border-left: 4px solid #6366f1;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .raid-info-box {
            background-color: #f0fdf4;
            border-left: 4px solid #22c55e;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800">OpenShift Sizing Calculator</h1>
            <p class="text-gray-600 mt-2">Estimate the required compute and storage nodes for your OpenShift cluster.</p>
        </header>

        <main>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                <!-- Workload Specification -->
                <div class="card lg:col-span-1">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Workload Specs</h2>
                    <div id="workload-list">
                        <!-- Dynamic workload entries will be injected here -->
                    </div>
                    <button id="add-workload-btn" class="mt-4 w-full bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        + Add Workload Type
                    </button>
                </div>

                <!-- Server Specification -->
                <div class="card lg:col-span-1">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Node Specs</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="physicalCpuPerServer" class="block text-sm font-medium text-gray-700">Physical CPUs per Node</label>
                            <input type="number" id="physicalCpuPerServer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., 8">
                        </div>
                         <div>
                            <label for="cpuConversionRatio" class="block text-sm font-medium text-gray-700">CPU to vCPU Ratio</label>
                            <input type="number" id="cpuConversionRatio" value="2" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="memPerServer" class="block text-sm font-medium text-gray-700">Memory per Node (GB)</label>
                            <input type="number" id="memPerServer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="e.g., 64">
                        </div>
                        <div>
                            <label for="maxUtilization" class="block text-sm font-medium text-gray-700">Max Host Utilization (%)</label>
                            <input type="number" id="maxUtilization" value="80" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                        </div>
                         <div class="pt-4 border-t divide-y divide-gray-200">
                             <label class="flex items-center py-2">
                                 <input type="checkbox" id="compact-cluster-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                 <span class="ml-2 text-sm text-gray-900 font-medium">Combine Control Plane & Worker Nodes</span>
                            </label>
                             <label class="flex items-center py-2">
                                 <input type="checkbox" id="failover-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                 <span class="ml-2 text-sm text-gray-900 font-medium">Add N+1 Failover Node</span>
                            </label>
                        </div>
                    </div>
                </div>

                 <!-- Infrastructure Stack Sizing -->
                <div class="card lg:col-span-2">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Infrastructure Stack Sizing</h2>
                    <label class="flex items-center mb-4">
                        <input type="checkbox" id="enable-stack-sizing-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-2 text-sm text-gray-900 font-medium">Enable Optional Infrastructure Stack Sizing</span>
                    </label>
                    <div id="stack-sizing-inputs" class="hidden space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- Small Cluster -->
                            <div class="space-y-2 p-2 border rounded-lg">
                                <h3 class="font-semibold text-center text-gray-600">Small Cluster (&lt;50 nodes)</h3>
                                <label class="block text-xs font-medium text-gray-600">Logging CPU</label>
                                <input type="number" id="small-logging-cpu" value="1.5" step="0.1" class="stack-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                <label class="block text-xs font-medium text-gray-600">Logging Memory (GB)</label>
                                <input type="number" id="small-logging-mem" value="49" step="0.1" class="stack-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                <label class="block text-xs font-medium text-gray-600">Mgmt CPU</label>
                                <input type="number" id="small-mgmt-cpu" value="3" step="0.1" class="stack-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                <label class="block text-xs font-medium text-gray-600">Mgmt Memory (GB)</label>
                                <input type="number" id="small-mgmt-mem" value="10.1" step="0.1" class="stack-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                            </div>
                            <!-- Medium Cluster -->
                            <div class="space-y-2 p-2 border rounded-lg">
                                <h3 class="font-semibold text-center text-gray-600">Medium Cluster (50-250)</h3>
                                <label class="block text-xs font-medium text-gray-600">Logging CPU</label>
                                <input type="number" id="medium-logging-cpu" value="5" step="0.1" class="stack-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                <label class="block text-xs font-medium text-gray-600">Logging Memory (GB)</label>
                                <input type="number" id="medium-logging-mem" value="162" step="0.1" class="stack-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                <label class="block text-xs font-medium text-gray-600">Mgmt CPU</label>
                                <input type="number" id="medium-mgmt-cpu" value="8" step="0.1" class="stack-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                <label class="block text-xs font-medium text-gray-600">Mgmt Memory (GB)</label>
                                <input type="number" id="medium-mgmt-mem" value="35.5" step="0.1" class="stack-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                            </div>
                            <!-- Large Cluster -->
                            <div class="space-y-2 p-2 border rounded-lg">
                                <h3 class="font-semibold text-center text-gray-600">Large Cluster (250+)</h3>
                                <label class="block text-xs font-medium text-gray-600">Logging CPU</label>
                                <input type="number" id="large-logging-cpu" value="10" step="0.1" class="stack-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                <label class="block text-xs font-medium text-gray-600">Logging Memory (GB)</label>
                                <input type="number" id="large-logging-mem" value="324" step="0.1" class="stack-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                <label class="block text-xs font-medium text-gray-600">Mgmt CPU</label>
                                <input type="number" id="large-mgmt-cpu" value="15" step="0.1" class="stack-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                                <label class="block text-xs font-medium text-gray-600">Mgmt Memory (GB)</label>
                                <input type="number" id="large-mgmt-mem" value="75" step="0.1" class="stack-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card lg:col-span-2">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Worker Node Components (DaemonSet)</h2>
                     <label class="flex items-center mb-4">
                        <input type="checkbox" id="enable-daemonset-sizing-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="ml-2 text-sm text-gray-900 font-medium">Enable Optional DaemonSet Overhead</span>
                    </label>
                    <div id="daemonset-sizing-inputs" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div class="space-y-2 p-2 border rounded-lg">
                             <h3 class="font-semibold text-center text-gray-600">Fluentd</h3>
                             <label class="block text-xs font-medium text-gray-600">CPU per Node (cores)</label>
                             <input type="number" id="fluentd-cpu" value="0.2" step="0.01" class="daemonset-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                             <label class="block text-xs font-medium text-gray-600">Memory per Node (GB)</label>
                             <input type="number" id="fluentd-mem" value="1" step="0.1" class="daemonset-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                         </div>
                         <div class="space-y-2 p-2 border rounded-lg">
                             <h3 class="font-semibold text-center text-gray-600">Node Exporter</h3>
                             <label class="block text-xs font-medium text-gray-600">CPU per Node (cores)</label>
                             <input type="number" id="node-exporter-cpu" value="0.05" step="0.01" class="daemonset-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                             <label class="block text-xs font-medium text-gray-600">Memory per Node (GB)</label>
                             <input type="number" id="node-exporter-mem" value="0.05" step="0.01" class="daemonset-input mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                         </div>
                    </div>
                </div>
                
                <!-- Storage, Growth -->
                <div class="grid md:grid-cols-2 lg:grid-cols-2 lg:col-span-4 gap-8">
                    <div class="card lg:col-span-1">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Storage & RAID Config</h2>
                        <div class="space-y-4">
                             <div>
                                <label for="totalStorage" class="block text-sm font-medium text-gray-700">Total Usable Storage Required (GB)</label>
                                <input type="number" id="totalStorage" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="totalIops" class="block text-sm font-medium text-gray-700">Total IOPS Required</label>
                                <input type="number" id="totalIops" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            </div>
                            <div class="pt-4 border-t">
                                 <h3 class="text-lg font-medium text-gray-800">Single Node/Array Config</h3>
                                 <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="capacityPerDisk" class="block text-sm font-medium text-gray-700">Capacity/Disk (GB)</label>
                                        <input type="number" id="capacityPerDisk" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="iopsPerDisk" class="block text-sm font-medium text-gray-700">IOPS/Disk</label>
                                        <input type="number" id="iopsPerDisk" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                         <label for="disksInArray" class="block text-sm font-medium text-gray-700">Disks in Array</label>
                                         <input type="number" id="disksInArray" value="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="raidLevel" class="block text-sm font-medium text-gray-700">RAID Level</label>
                                        <select id="raidLevel" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                            <option value="none">None</option>
                                            <option value="0">RAID 0</option>
                                            <option value="1">RAID 1</option>
                                            <option value="5">RAID 5</option>
                                            <option value="6">RAID 6</option>
                                            <option value="10">RAID 10</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="raid-results-display" class="mt-4"></div>
                            </div>
                        </div>
                    </div>
                    <!-- Growth Projection -->
                    <div class="card lg:col-span-1">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Growth Projection (Optional)</h2>
                        <div class="space-y-4">
                            <div class="pt-2">
                                <label class="flex items-center">
                                    <input type="checkbox" id="growth-checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <span class="ml-2 text-sm text-gray-900 font-medium">Enable Growth Projection</span>
                                </label>
                            </div>
                            <div id="growth-inputs" class="space-y-4 hidden">
                                 <div>
                                    <label for="cpuGrowthPercentage" class="block text-sm font-medium text-gray-700">Annual CPU Growth (%)</label>
                                    <input type="number" id="cpuGrowthPercentage" value="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                 <div>
                                    <label for="memGrowthPercentage" class="block text-sm font-medium text-gray-700">Annual Memory Growth (%)</label>
                                    <input type="number" id="memGrowthPercentage" value="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="forecastPeriod" class="block text-sm font-medium text-gray-700">Forecast Period (Months)</label>
                                    <input type="number" id="forecastPeriod" value="12" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-8">
                <button id="calculateBtn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 text-lg">
                    Calculate
                </button>
            </div>

            <!-- Results -->
            <div id="results" class="mt-8 card result-card hidden">
                 <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-semibold text-gray-700">Sizing Recommendation</h2>
                    <button id="save-excel-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Save to Excel
                    </button>
                </div>
                 <div id="workload-summary-details" class="mb-6"></div>
                 <div id="results-content" class="grid md:grid-cols-2 gap-8"></div>
                 <div id="growth-recommendation-details" class="mt-6"></div>
                 <div id="graph-details" class="mt-6"></div>
                 <div id="growth-graph-details" class="mt-6"></div>
                 <div id="overhead-details" class="mt-6"></div>
                 <p id="error" class="text-red-500 mt-4 font-semibold"></p>
            </div>
        </main>
    </div>

    <script>
        // --- DOM Element Selectors ---
        const workloadList = document.getElementById('workload-list');
        const addWorkloadBtn = document.getElementById('add-workload-btn');
        let workloadId = 0;
        let cpuChart = null;
        let memChart = null;
        let utilizationGrowthChart = null;
        let excelData = {}; // Global object to store calculation data for Excel export

        /**
         * Calculates system overhead for a single node based on its resources.
         * CPU and Memory reservations are now dynamic based on Red Hat's formulas.
         * @param {number} physicalCpus - The number of physical CPU cores on the node.
         * @param {number} mem - The total memory (GB) on the node.
         * @param {number} cpuRatio - The configured CPU to vCPU conversion ratio.
         * @returns {{reservedVcpu: number, reservedMem: number}} - The reserved vCPU and Memory.
         */
        function calculateOverhead(physicalCpus, mem, cpuRatio) {
            let reservedCores;
            if (physicalCpus <= 1) {
                reservedCores = 0.06;
            } else {
                reservedCores = (0.06 + 0.012) * (physicalCpus - 1);
            }
            const reservedVcpu = reservedCores * cpuRatio;
    
            let reservedMem = 0;
            if (mem > 0) {
                const firstChunk = Math.min(mem, 4);
                reservedMem += firstChunk * 0.25;
            }
            if (mem > 4) {
                const secondChunk = Math.min(mem - 4, 4);
                reservedMem += secondChunk * 0.20;
            }
            if (mem > 8) {
                const thirdChunk = Math.min(mem - 8, 8);
                reservedMem += thirdChunk * 0.10;
            }
            if (mem > 16) {
                const fourthChunk = Math.min(mem - 16, 112);
                reservedMem += fourthChunk * 0.06;
            }
            if (mem > 128) {
                const fifthChunk = mem - 128;
                reservedMem += fifthChunk * 0.02;
            }
            
            return { reservedVcpu, reservedMem };
        }

        /**
         * Calculates the resource requirements for the optional infrastructure stacks.
         * @param {string} clusterSize - The calculated size of the cluster ('Small', 'Medium', 'Large').
         * @returns {{cpu: number, memory: number}} - The additional resources required for the enabled stacks.
         */
        function calculateStackRequirements(clusterSize) {
             if (!document.getElementById('enable-stack-sizing-checkbox').checked) {
                 return { cpu: 0, memory: 0 };
             }

             const sizePrefix = clusterSize.toLowerCase();
             const loggingCpu = parseFloat(document.getElementById(`${sizePrefix}-logging-cpu`).value) || 0;
             const loggingMem = parseFloat(document.getElementById(`${sizePrefix}-logging-mem`).value) || 0;
             const mgmtCpu = parseFloat(document.getElementById(`${sizePrefix}-mgmt-cpu`).value) || 0;
             const mgmtMem = parseFloat(document.getElementById(`${sizePrefix}-mgmt-mem`).value) || 0;
             
             const totalStackCpu = loggingCpu + mgmtCpu;
             const totalStackMem = loggingMem + mgmtMem;

             return { cpu: totalStackCpu, memory: totalStackMem };
        }
        
        /**
         * Calculates the resource overhead for DaemonSets on each worker node.
         * @returns {{cpu: number, memory: number}} - The per-node resources required for DaemonSets.
         */
        function calculateDaemonSetOverhead() {
            if (!document.getElementById('enable-daemonset-sizing-checkbox').checked) {
                return { cpu: 0, memory: 0 };
            }
            const fluentdCpu = parseFloat(document.getElementById('fluentd-cpu').value) || 0;
            const fluentdMem = parseFloat(document.getElementById('fluentd-mem').value) || 0;
            const nodeExporterCpu = parseFloat(document.getElementById('node-exporter-cpu').value) || 0;
            const nodeExporterMem = parseFloat(document.getElementById('node-exporter-mem').value) || 0;

            return {
                cpu: fluentdCpu + nodeExporterCpu,
                memory: fluentdMem + nodeExporterMem
            };
        }


        /**
         * Creates a new workload entry form and appends it to the list.
         */
        function createWorkloadEntry() {
            workloadId++;
            const entryDiv = document.createElement('div');
            entryDiv.className = 'workload-entry border-t pt-4 mt-4 space-y-2';
            entryDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <input type="text" placeholder="Workload Name (e.g., VMs, Web Pods)" class="workload-name block w-full rounded-md border-gray-300 shadow-sm sm:text-sm font-semibold">
                    <button type="button" class="remove-workload-btn text-red-500 hover:text-red-700 ml-4 font-bold text-xl">&times;</button>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Instances</label>
                        <input type="number" value="0" class="workload-instances mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">vCPU/Inst</label>
                        <input type="number" step="0.1" value="0" class="workload-vcpu mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Mem/Inst</label>
                        <input type="number" step="0.1" value="0" class="workload-mem mt-1 block w-full rounded-md border-gray-300 shadow-sm sm:text-sm">
                    </div>
                </div>
            `;
            workloadList.appendChild(entryDiv);
        }
        
        // --- Initial Setup and Event Listeners ---
        createWorkloadEntry();
        addWorkloadBtn.addEventListener('click', createWorkloadEntry);

        workloadList.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-workload-btn')) {
                e.target.closest('.workload-entry').remove();
            }
        });

        document.getElementById('growth-checkbox').addEventListener('change', function() {
            document.getElementById('growth-inputs').classList.toggle('hidden', !this.checked);
        });

        document.getElementById('enable-stack-sizing-checkbox').addEventListener('change', function() {
            const isEnabled = this.checked;
            document.getElementById('stack-sizing-inputs').classList.toggle('hidden', !isEnabled);
            document.querySelectorAll('.stack-input').forEach(input => input.disabled = !isEnabled);
        });
        
         document.getElementById('enable-daemonset-sizing-checkbox').addEventListener('change', function() {
            const isEnabled = this.checked;
            document.getElementById('daemonset-sizing-inputs').classList.toggle('hidden', !isEnabled);
            document.querySelectorAll('.daemonset-input').forEach(input => input.disabled = !isEnabled);
        });

        // Initial state for optional inputs
        document.querySelectorAll('.stack-input').forEach(input => input.disabled = true);
        document.querySelectorAll('.daemonset-input').forEach(input => input.disabled = true);


        function updateRAIDCalculation() {
            const raidLevel = document.getElementById('raidLevel').value;
            const numDisks = parseInt(document.getElementById('disksInArray').value) || 0;
            const capacityPerDisk = parseInt(document.getElementById('capacityPerDisk').value) || 0;
            const displayDiv = document.getElementById('raid-results-display');

            if (raidLevel === 'none' || numDisks === 0 || capacityPerDisk === 0) {
                displayDiv.innerHTML = '';
                return;
            }

            let usableCapacity = 0, faultTolerance = 'None', minDisks = 0, errorMsg = '';

            switch(raidLevel) {
                case '0':
                    minDisks = 2;
                    if (numDisks < minDisks) errorMsg = `RAID 0 requires at least ${minDisks} disks.`;
                    usableCapacity = numDisks * capacityPerDisk;
                    faultTolerance = '0 disks';
                    break;
                case '1':
                    minDisks = 2;
                    if (numDisks < minDisks || numDisks % 2 !== 0) errorMsg = `RAID 1 requires an even number of disks (min ${minDisks}).`;
                    usableCapacity = (numDisks / 2) * capacityPerDisk;
                    faultTolerance = '1 disk per mirror set';
                    break;
                case '5':
                    minDisks = 3;
                    if (numDisks < minDisks) errorMsg = `RAID 5 requires at least ${minDisks} disks.`;
                    usableCapacity = (numDisks - 1) * capacityPerDisk;
                    faultTolerance = '1 disk';
                    break;
                case '6':
                    minDisks = 4;
                    if (numDisks < minDisks) errorMsg = `RAID 6 requires at least ${minDisks} disks.`;
                    usableCapacity = (numDisks - 2) * capacityPerDisk;
                    faultTolerance = '2 disks';
                    break;
                case '10':
                    minDisks = 4;
                     if (numDisks < minDisks || numDisks % 2 !== 0) errorMsg = `RAID 10 requires an even number of disks (min ${minDisks}).`;
                    usableCapacity = (numDisks / 2) * capacityPerDisk;
                    faultTolerance = '1 disk per sub-array';
                    break;
            }
            
            if (errorMsg) {
                displayDiv.innerHTML = `<p class="text-sm font-medium text-red-600">${errorMsg}</p>`;
            } else {
                 displayDiv.innerHTML = `<div class="raid-info-box"><h4 class="font-semibold text-gray-800">RAID Array Summary:</h4><ul class="list-disc list-inside text-sm text-gray-600 mt-2 space-y-1"><li>Usable Capacity: <span class="font-bold text-green-700">${usableCapacity.toFixed(1)} GB</span></li><li>Fault Tolerance: <span class="font-semibold">${faultTolerance}</span></li></ul></div>`;
            }
        }

        const raidInputs = ['raidLevel', 'disksInArray', 'capacityPerDisk'];
        raidInputs.forEach(id => {
            document.getElementById(id).addEventListener('input', updateRAIDCalculation);
        });
        updateRAIDCalculation();

        document.getElementById('calculateBtn').addEventListener('click', function() {
            excelData = { inputs: [], results: {} };
            
            let initialAppWorkloadVcpu = 0, initialAppWorkloadMem = 0;
            document.querySelectorAll('.workload-entry').forEach(entry => {
                const name = entry.querySelector('.workload-name').value || 'Unnamed Workload';
                const instances = parseInt(entry.querySelector('.workload-instances').value) || 0;
                const vcpu = parseFloat(entry.querySelector('.workload-vcpu').value) || 0;
                const mem = parseFloat(entry.querySelector('.workload-mem').value) || 0;
                initialAppWorkloadVcpu += instances * vcpu;
                initialAppWorkloadMem += instances * mem;
            });
            
            const physicalCpuPerServer = parseInt(document.getElementById('physicalCpuPerServer').value) || 0;
            const cpuConversionRatio = parseFloat(document.getElementById('cpuConversionRatio').value) || 1;
            const memPerServer = parseInt(document.getElementById('memPerServer').value) || 0;
            const maxUtilization = parseInt(document.getElementById('maxUtilization').value) || 100;
            const isCompactCluster = document.getElementById('compact-cluster-checkbox').checked;
            const addFailoverNode = document.getElementById('failover-checkbox').checked;

            const enableGrowth = document.getElementById('growth-checkbox').checked;
            const cpuGrowthPercentage = parseInt(document.getElementById('cpuGrowthPercentage').value) || 0;
            const memGrowthPercentage = parseInt(document.getElementById('memGrowthPercentage').value) || 0;
            const forecastPeriod = parseInt(document.getElementById('forecastPeriod').value) || 0;
            
            const resultsDiv = document.getElementById('results');
            const errorDiv = document.getElementById('error');
            ['results-content', 'workload-summary-details', 'graph-details', 'growth-graph-details', 'overhead-details', 'growth-recommendation-details'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '';
            });
            errorDiv.textContent = '';
            resultsDiv.classList.add('hidden');

            if (physicalCpuPerServer <= 0 || memPerServer <= 0 || cpuConversionRatio <= 0 || maxUtilization <= 0 || maxUtilization > 100) {
                errorDiv.textContent = 'Physical CPUs, Memory, Ratio, and Utilization must be valid positive numbers. Utilization cannot exceed 100%.';
                resultsDiv.classList.remove('hidden');
                return;
            }
            
            const cpNodeCount = 3, cpVcpuPerNode = 8, cpMemPerNode = 16;
            const cpTotalVcpu = isCompactCluster ? cpNodeCount * cpVcpuPerNode : 0;
            const cpTotalMem = isCompactCluster ? cpNodeCount * cpMemPerNode : 0;
            
            // Calculate per-node overheads
            const { reservedVcpu: systemReservedVcpu, reservedMem: systemReservedMem } = calculateOverhead(physicalCpuPerServer, memPerServer, cpuConversionRatio);
            const daemonSetOverhead = calculateDaemonSetOverhead();

            // Calculate final allocatable resources per node
            const totalAvailableVcpu = physicalCpuPerServer * cpuConversionRatio;
            const usableVcpuPerNode = totalAvailableVcpu - systemReservedVcpu - daemonSetOverhead.cpu;
            const usableMemPerNode = memPerServer - systemReservedMem - daemonSetOverhead.memory;
            
            const allocatableVcpuPerServer = usableVcpuPerNode * (maxUtilization / 100);
            const allocatableMemPerServer = usableMemPerNode * (maxUtilization / 100);

            if (allocatableVcpuPerServer <= 0 || allocatableMemPerServer <= 0) {
                 errorDiv.textContent = 'Node specification is too low for the calculated system and DaemonSet overhead.';
                 resultsDiv.classList.remove('hidden');
                 return;
            }

            // --- Iterative Sizing for Infrastructure Stack Overhead ---
            let appAndCpWorkloadVcpu = initialAppWorkloadVcpu + (isCompactCluster ? cpTotalVcpu : 0);
            let appAndCpWorkloadMem = initialAppWorkloadMem + (isCompactCluster ? cpTotalMem : 0);
            
            let stackOverhead = { cpu: 0, memory: 0 };
            let finalClusterSize = 'Small';

            for (let i = 0; i < 2; i++) { // Two passes are sufficient to stabilize the calculation
                const tempTotalWorkloadVcpu = appAndCpWorkloadVcpu + stackOverhead.cpu;
                const tempTotalWorkloadMem = appAndCpWorkloadMem + stackOverhead.memory;

                const workerNodesByCpu = Math.ceil(tempTotalWorkloadVcpu / allocatableVcpuPerServer);
                const workerNodesByMem = Math.ceil(tempTotalWorkloadMem / allocatableMemPerServer);
                
                const calculatedWorkerNodes = Math.max(isCompactCluster ? 3 : 2, workerNodesByCpu, workerNodesByMem);
                const totalNodes = (isCompactCluster ? 0 : 3) + calculatedWorkerNodes;
                
                if (totalNodes < 50) finalClusterSize = 'Small';
                else if (totalNodes <= 250) finalClusterSize = 'Medium';
                else finalClusterSize = 'Large';

                stackOverhead = calculateStackRequirements(finalClusterSize);
            }

            // Final current workload including the stabilized stack overhead
            const currentTotalWorkloadVcpu = appAndCpWorkloadVcpu + stackOverhead.cpu;
            const currentTotalWorkloadMem = appAndCpWorkloadMem + stackOverhead.memory;
            
            // Final Node Calculation with Growth
            let finalProjectedVcpu = currentTotalWorkloadVcpu;
            let finalProjectedMem = currentTotalWorkloadMem;
            if (enableGrowth) {
                const monthlyCpuGrowthRate = (cpuGrowthPercentage / 100) / 12;
                const monthlyMemGrowthRate = (memGrowthPercentage / 100) / 12;
                const projectedAppVcpu = initialAppWorkloadVcpu * Math.pow(1 + monthlyCpuGrowthRate, forecastPeriod);
                const projectedAppMem = initialAppWorkloadMem * Math.pow(1 + monthlyMemGrowthRate, forecastPeriod);
                finalProjectedVcpu = projectedAppVcpu + (isCompactCluster ? cpTotalVcpu : 0) + stackOverhead.cpu;
                finalProjectedMem = projectedAppMem + (isCompactCluster ? cpTotalMem : 0) + stackOverhead.memory;
            }

            let workerNodes = 0;
            if (isCompactCluster) {
                const compactNodes = Math.max(3, Math.ceil(finalProjectedVcpu / allocatableVcpuPerServer), Math.ceil(finalProjectedMem / allocatableMemPerServer));
                workerNodes = compactNodes + (addFailoverNode ? 1 : 0);
            } else {
                const calculatedWorkerNodes = Math.max(2, Math.ceil(finalProjectedVcpu / allocatableVcpuPerServer), Math.ceil(finalProjectedMem / allocatableMemPerServer));
                workerNodes = calculatedWorkerNodes + (addFailoverNode ? 1 : 0);
            }

            // --- Display Results ---
            document.getElementById('workload-summary-details').innerHTML = `<div class="bg-white p-4 rounded-lg shadow-sm border"><h3 class="text-lg font-semibold text-gray-800 mb-2">Total Aggregated Workload</h3><div class="grid grid-cols-2 gap-4 text-center"><div><p class="text-sm text-gray-500">App vCPU Required</p><p class="text-xl font-bold text-indigo-600">${initialAppWorkloadVcpu.toFixed(2)}</p></div><div><p class="text-sm text-gray-500">App Memory Required</p><p class="text-xl font-bold text-indigo-600">${initialAppWorkloadMem.toFixed(2)} GB</p></div>${(stackOverhead.cpu > 0 || stackOverhead.memory > 0) ? `<div><p class="text-sm text-gray-500">Stack vCPU Overhead</p><p class="text-xl font-bold text-red-500">${stackOverhead.cpu.toFixed(2)}</p></div><div><p class="text-sm text-gray-500">Stack Memory Overhead</p><p class="text-xl font-bold text-red-500">${stackOverhead.memory.toFixed(2)} GB</p></div>` : ''}${enableGrowth && forecastPeriod > 0 ? `<div><p class="text-sm text-gray-500">Projected Total vCPU</p><p class="text-xl font-bold text-purple-600">${finalProjectedVcpu.toFixed(2)}</p></div><div><p class="text-sm text-gray-500">Projected Total Memory</p><p class="text-xl font-bold text-purple-600">${finalProjectedMem.toFixed(2)} GB</p></div>` : ''}</div></div>`;

            let resultsHTML = '';
             if (isCompactCluster) {
                resultsHTML = `<div class="md:col-span-2"><h3 class="text-lg font-medium text-gray-900">Combined (Control+Worker) Cluster</h3><div class="mt-2 text-gray-600"><p class="text-2xl font-bold text-indigo-600">${workerNodes} <span class="text-lg font-medium text-gray-800">nodes</span> ${addFailoverNode ? `<span class="text-xs font-medium text-green-700">(N+1)</span>` : ''}</p></div></div>`;
            } else {
                resultsHTML = `<div><h3 class="text-lg font-medium text-gray-900">Control Plane</h3><div class="mt-2 text-gray-600"><p class="text-2xl font-bold text-indigo-600">3 <span class="text-lg font-medium text-gray-800">nodes</span></p></div></div><div><h3 class="text-lg font-medium text-gray-900">Worker Nodes</h3><div class="mt-2 text-gray-600"><p class="text-2xl font-bold text-indigo-600">${workerNodes} <span class="text-lg font-medium text-gray-800">nodes</span> ${addFailoverNode ? `<span class="text-xs font-medium text-green-700">(N+1)</span>` : ''}</p></div></div>`;
            }

            document.getElementById('results-content').innerHTML = resultsHTML;
            document.getElementById('overhead-details').innerHTML = `<div class="info-box"><h4 class="font-semibold text-gray-800">Node Breakdown:</h4><ul class="list-disc list-inside text-sm text-gray-600 mt-2 space-y-1"><li>Total resources per node: <span class="font-semibold">${physicalCpuPerServer} Physical CPUs (${(physicalCpuPerServer * cpuConversionRatio).toFixed(1)} vCPU)</span> & <span class="font-semibold">${memPerServer} GB</span></li><li>System overhead per node: <span class="font-semibold">${systemReservedVcpu.toFixed(2)} vCPU</span> & <span class="font-semibold">${systemReservedMem.toFixed(2)} GB</span></li><li>DaemonSet overhead per node: <span class="font-semibold">${daemonSetOverhead.cpu.toFixed(2)} vCPU</span> & <span class="font-semibold">${daemonSetOverhead.memory.toFixed(2)} GB</span></li><li class="font-bold">Usable resources per node: <span class="font-semibold">${usableVcpuPerNode.toFixed(2)} vCPU</span> & <span class="font-semibold">${usableMemPerNode.toFixed(2)} GB</span></li><li class="font-medium">Allocatable resources at ${maxUtilization}%: <span class="font-semibold">${allocatableVcpuPerServer.toFixed(2)} vCPU</span> & <span class="font-semibold">${allocatableMemPerServer.toFixed(2)} GB</span></li></ul></div>`;

            resultsDiv.classList.remove('hidden');

        });

    </script>
</body>
</html>
